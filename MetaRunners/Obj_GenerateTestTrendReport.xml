<?xml version="1.0" encoding="UTF-8"?>
<meta-runner name="Obj: Test Trend Report">
  <description>Generates a trend report basing on test results.</description>
  <settings>
    <parameters>
      <param name="system.testName.regex" value="" spec="text validationMode='any' label='Regex for displaying test names' description='If your test name is LongTestPrefix-ActualTestName, you can provide regex LongTestPrefix-(.*) to output only ActualTestName' display='normal'" />
      <param name="system.numberOfLastBuilds" value="30" spec="text validationMode='not_empty' label='Number of last builds' description='Number of builds that will be trended - all earlier builds will be ignored' display='normal'" />
      <param name="system.generateCsv" value="$false" spec="checkbox checkedValue='$true' description='If checked, CSV file will be generated' uncheckedValue='$false' label='Generate CSV' display='normal'" />
      <param name="trendReport.password" value="" spec="password display='hidden'" />
      <param name="trendReport.userId" value="" spec="text display='hidden'"/>
    </parameters>
    <build-runners>
      <runner name="Generate Test Trend Reports" type="jetbrains_powershell">
        <parameters>
          <param name="jetbrains_powershell_bitness" value="x86" />
          <param name="jetbrains_powershell_execution" value="PS1" />
          <param name="jetbrains_powershell_script_code"><![CDATA[. c:\PSCI\Boot\PSCI.boot.ps1
try { 

$user = '%trendReport.userId%'
$pass = '%trendReport.password%'
if (!$user -or !$pass) {
    throw "Either trendReport.userId or trendReport.password is empty. Please modify this metarunner to include valid userId and password."
}

$serverUrl = '%teamcity.serverUrl%' -replace 'http://',''
$connectionString = "Server=${serverUrl};Database=TeamCity;User Id=${user};Password=${pass}"

New-TeamcityTrendReport -TeamcityBuildId '%teamcity.build.id%' -TeamcityDbConnectionString $connectionString -OutputDir 'TestTrend' -TestNameRegex '%system.testName.regex%' -NumberOfLastBuilds %system.numberOfLastBuilds% -GenerateCsvFile:%system.generateCsv%

Write-Host "##teamcity[publishArtifacts 'TestTrend => TestTrend']"
} catch {
Write-ErrorRecord
}]]></param>
          <param name="jetbrains_powershell_script_mode" value="CODE" />
          <param name="teamcity.step.mode" value="default" />
        </parameters>
      </runner>
    </build-runners>
    <requirements />
  </settings>
</meta-runner>

